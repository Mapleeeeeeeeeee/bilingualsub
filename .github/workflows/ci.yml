name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ===========================================
  # Lint & Type Check (Fast, runs first)
  # ===========================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Ruff lint
        run: uv run ruff check src/ tests/

      - name: Ruff format check
        run: uv run ruff format --check src/ tests/

      - name: Mypy type check
        run: uv run mypy src/

      - name: Vulture dead code check
        run: uv run vulture src/bilingualsub --min-confidence=80

  # ===========================================
  # Frontend Lint (Prettier)
  # ===========================================
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install prettier
        run: npm install -g prettier

      - name: Prettier check
        run: prettier --check "**/*.{js,jsx,ts,tsx,json,yaml,md,html,css}" --ignore-path .prettierignore

  # ===========================================
  # Unit Tests (Fast, no external deps)
  # ===========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run unit tests
        run: |
          uv run pytest tests/unit \
            -m "unit" \
            --cov=bilingualsub \
            --cov-report=xml \
            --cov-fail-under=60

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unit
          fail_ci_if_error: false

  # ===========================================
  # Integration Tests (May use real deps)
  # ===========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run integration tests
        run: |
          uv run pytest tests/integration \
            -m "integration" \
            --cov=bilingualsub \
            --cov-report=xml \
            --cov-fail-under=30

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: integration
          fail_ci_if_error: false

  # ===========================================
  # E2E Tests (Full workflow, Playwright)
  # ===========================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies (with e2e)
        run: uv sync --extra dev --extra e2e

      - name: Install Playwright browsers
        run: uv run playwright install --with-deps chromium

      - name: Run E2E tests
        run: |
          uv run pytest tests/e2e \
            -m "e2e" \
            --cov-fail-under=0
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # ===========================================
  # Security Scan
  # ===========================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run pip-audit
        run: uv run pip-audit
        continue-on-error: true

      - name: Run Bandit security scan
        run: uv run bandit -c pyproject.toml -r src/

  # ===========================================
  # All checks passed
  # ===========================================
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, frontend-lint, unit-tests, integration-tests, e2e-tests, security]
    steps:
      - name: All checks passed
        run: echo "All CI checks passed successfully!"
